<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keshava Jewellers</title>
    <style>
        /* === KESHAVA JEWELLERS - MOBILE-FIRST MIDNIGHT GOLD THEME === */

        /* 1. Theme Variables & Global Styles */
        :root {
            --gold: #D4AF37;
            --dark-gold: #b98d28;
            --navy-dark: #0d1a26;
            --navy-medium: #1a2f40;
            --navy-light: #2a4a69;
            --text-light: #c5d1e0;
            --text-white: #ffffff;
            --font-serif: 'Georgia', 'Times New Roman', serif;
            --font-sans: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background-color: var(--navy-dark);
            color: var(--text-light);
            margin: 0;
            padding: 1rem;
        }

        /* 2. Main App Layout & Styles */
        .app-container {
            width: 100%;
            max-width: 600px; /* Optimal for mobile and desktop viewing */
            margin: 0 auto;
        }

        .form-panel { 
            padding: 1.5rem; 
            background: var(--navy-medium); 
            border-radius: 12px; 
            border: 1px solid var(--navy-light);
        }

        .app-header { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--navy-light); 
            padding-bottom: 1rem; 
            margin-bottom: 1.5rem; 
            gap: 1rem;
        }
        .app-header h2 { 
            color: var(--text-white); 
            font-weight: 500; 
            margin: 0; 
            flex-basis: 100%; 
            text-align: center;
        }
        .header-buttons { 
            display: flex; 
            gap: 1rem;
            width: 100%;
            justify-content: flex-end; /* Aligned logout to the right */
        }
        #logout-btn { 
            background: var(--navy-light); 
            color: var(--text-light); 
            border: none; 
            padding: 0.6rem 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.9rem;
        }
        #logout-btn:hover { 
            background: var(--gold); 
            color: var(--navy-dark); 
        }

        .form-section { 
            margin-bottom: 2rem; 
        }
        .form-section h3 { 
            font-family: var(--font-serif); 
            color: var(--gold); 
            border-bottom: 1px solid var(--navy-light); 
            padding-bottom: 0.5rem; 
            margin-bottom: 1.5rem; 
            font-weight: 500; 
        }

        label { 
            display: block; 
            margin-bottom: 0.5rem; 
        }
        input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--navy-dark);
            border: 1px solid var(--navy-light);
            color: var(--text-white);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .radio-group { 
            display: flex; 
            gap: 1.5rem; 
            margin-top: 0.5rem; 
        }
        .radio-group input { 
            display: none; 
        }
        .radio-group label { 
            position: relative; 
            padding-left: 25px; 
            cursor: pointer; 
        }
        .radio-group label::before, .radio-group label::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .radio-group label::before { 
            left: 0; 
            top: 2px; 
            width: 16px; 
            height: 16px; 
            border: 2px solid var(--navy-light); 
        }
        .radio-group label::after { 
            left: 5px; 
            top: 7px; 
            width: 8px; 
            height: 8px; 
            background: var(--gold); 
            opacity: 0; 
            transform: scale(0); 
        }
        .radio-group input:checked + label::before { 
            border-color: var(--gold); 
        }
        .radio-group input:checked + label::after { 
            opacity: 1; 
            transform: scale(1); 
        }
        
        .total-display { 
            background: var(--gold); 
            color: var(--navy-dark); 
            padding: 1rem; 
            text-align: center; 
            border-radius: 8px; 
            margin-top: 1rem; 
        }
        .total-display small { 
            display: block; 
            opacity: 0.8; 
        }
        .total-display strong { 
            font-size: 2rem; 
        }
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin-top: 1.5rem; 
        }
        .action-buttons button { 
            width: 100%; 
            padding: 0.9rem; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: bold;
            font-size: 1rem;
        }
        #saveBtn { 
            background: var(--gold); 
            color: var(--navy-dark); 
            grid-column: 1 / -1; /* Span full width */
        }
        #printBtn, #restoreBtn, #newSlipBtn { 
            background: var(--navy-light); 
            color: var(--text-light); 
        }
        #printBtn:disabled, #restoreBtn:disabled { 
            background: var(--navy-medium); 
            color: #555; 
            cursor: not-allowed; 
        }

        /* 5. PERFECTED PRINT STYLES - THIS SECTION IS NOW CORRECTED */
        .print-only { 
            display: none; /* Hide on screen */
        }

        @page { 
            size: 80mm auto; /* Set paper width, height is automatic */
            margin: 0; /* No printer-level margins */
        }

      @media print {
      @page {
        size: 80mm auto;    /* exact width for 3-inch paper */
        margin: 0;
      }
    
      html, body {
        width: 80mm;
        margin: 0;
        padding: 0;
        background: #fff !important;
      }
    
      /* Hide everything else on the page completely */
      body * {
        display: none !important;
      }
    
      /* Show ONLY the print slip container and its contents */
      #print-slip,
      #print-slip * {
        display: block !important;
        visibility: visible !important;
      }
    
      /* ==== PRINT SLIP STYLES ==== */
      #print-slip {
        width: 100%;
        max-width: 80mm;    /* ensure it fits the paper width */
        margin: 0 auto;     /* center slip on page */
        padding: 2.8mm;
        box-sizing: border-box;
        font-family: 'Courier New', monospace;
        font-size: 9pt;
        color: #000;
      }
    
      .print-header, .print-main, .print-footer {
        display: block;
        width: 100%;
      }
    
      .print-header {
        text-align: center;
        margin-bottom: 2px;
      }
    
      .print-header h3 {
        font-size: 11pt;
        margin: 0;
      }
    
      .divider {
        border-bottom: 1px dashed #000;
        /* margin: 2px 0; */
      }
    
      .print-main {
        margin-bottom: 2px;
      }
    
      .print-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0 auto;/* Align text perfectly in one line */
        border-bottom: 1px solid #000; /* Underline for each row */
        padding: 2px 0;               /* Proper vertical spacing */
        font-size: 9pt;
      }
    
      .print-row .label {
        font-weight: bold;
        white-space: nowrap;
        flex: 1;
      }
    
      .print-row .value {
        text-align: right;
        flex: 1;
      }
    
      .total-row {
        font-weight: bold;
        margin-top: 3px;
      }
    
      .print-footer {
        text-align: center;
        font-size: 7.5pt;
        margin-top: 5px;
        border-top: 1px dashed #000;
        padding-top: 2px;
      }
    
      #print-slip {
        page-break-after: avoid;
      }
    }
    </style>
</head>
<div class="app-container">
        <div class="form-panel">
            <header class="app-header">
                <h2>Keshava Jewellers</h2>
                <div class="header-buttons">
                    <button id="logout-btn">Logout</button>
                </div>
            </header>

            <form id="estimation-form">
                <section class="form-section">
                    <h3>Customer Details</h3>
                    <label for="customerName">Customer Name*</label>
                    <input type="text" id="customerName" required>
                    <label for="mobileNumber">Mobile Number</label>
                    <input type="tel" id="mobileNumber" maxlength="10">
                    <label for="city">City</label>
                    <input type="text" id="city">
                    <label for="panNumber">PAN Number</label>
                    <input type="text" id="panNumber" maxlength="10">
                </section>

                <section class="form-section">
                    <h3>Ornament Details</h3>

                    <!-- Ornament Dropdown -->
                    <label for="ornamentCategory">Ornament Category*</label>
                    <select id="ornamentCategory" required>
                        <option value="">-- Select Category --</option>
                        <!-- Options will be populated by JS -->
                    </select>

                    <!-- Hidden input for "Other Specify" -->
                    <label for="ornamentOther" id="ornamentOtherLabel" style="display: none;">Specify Ornament*</label>
                    <input type="text" id="ornamentOther" placeholder="Enter custom ornament name">

                    <!-- Purity Dropdown -->
                    <label for="purity">Purity (Optional)</label>
                    <select id="purity">
                        <option value="">-- Select Purity --</option>
                         <!-- Options will be populated by JS -->
                    </select>

                    <label for="rate">Gold/Silver Rate (per gram)*</label>
                    <input type="number" id="rate" required>
                    <label for="quantity">Quantity (in gms)*</label>
                    <input type="number" step="0.001" id="quantity" required>
                    <label>Making Charges Type*</label>
                    <div class="radio-group">
                        <input type="radio" id="mcGrams" name="mcType" value="grams" checked>
                        <label for="mcGrams">In Grams</label>
                        <input type="radio" id="mcPercent" name="mcType" value="percent">
                        <label for="mcPercent">In %</label>
                    </div>
                    <label for="makingCharges">Making Charges*</label>
                    <input type="number" step="0.01" id="makingCharges" required>
                    <label for="stoneCharges">Stone Charges (if any)</label>
                    <input type="number" step="0.01" id="stoneCharges" value="0">
                </section>

                <section class="total-display">
                    <small>Total Amount (incl. 3% GST)</small>
                    <strong id="final-total">₹ 0.00</strong>
                </section>

                <section class="action-buttons">
                    <!-- Buttons are dynamically controlled by script -->
                </section>
            </form>
        </div>
    </div>

    <!-- Hidden slip for actual printing -->
    <div id="print-slip" class="print-only"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // =================================================================
        // ==== CONFIGURATION & API KEYS ====
        // =================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCKEMK9IL_aDv1FIGKdzNzCtKYMmSrMxQA",
          authDomain: "mksjewels-estimator.firebaseapp.com",
          projectId: "mksjewels-estimator",
          storageBucket: "mksjewels-estimator.firebasestorage.app",
          messagingSenderId: "686445291013",
          appId: "1:686445291013:web:b8783b0f050f7d1955de6c",
        };

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyC-NIj62N-QdaVysFFzctbUeu29lk-yuvajlgQNrdex95qAfDyHkgKaLsaEcaPwSHHHw/exec';

        // =================================================================
        // =================== APPLICATION LOGIC (SIMPLIFIED) ===================
        // =================================================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // --- AUTH GUARD & AUTO-LOGOUT ---
        const userJSON = sessionStorage.getItem('employeeUser');
        if (!userJSON || (new Date().getTime() - JSON.parse(userJSON).loginTime > 24 * 60 * 60 * 1000)) {
            sessionStorage.removeItem('employeeUser');
            localStorage.removeItem('lastEntry');
            if (userJSON) alert('Your session has expired. Please log in again.');
            window.location.href = 'index.html'; // Fixed: Use root-relative path
        }

        // --- DOM ELEMENT SELECTORS ---
        const form = document.getElementById('estimation-form');
        const elements = {
            logoutBtn: document.getElementById('logout-btn'),
            finalTotal: document.getElementById('final-total'),
            printSlipContainer: document.getElementById('print-slip'),
            actionButtons: document.querySelector('.action-buttons'),
            ornamentCategory: document.getElementById('ornamentCategory'),
            ornamentOther: document.getElementById('ornamentOther'),
            ornamentOtherLabel: document.getElementById('ornamentOtherLabel'),
            purity: document.getElementById('purity'), // New Purity selector
        };
        let estimationId = null; // To hold the current slip's ID

        // --- DROPDOWN OPTIONS (SORTED) ---
        const ornamentOptions = [
            { value: "BANGLES", text: "BANGLES" },
            { value: "BOWL", text: "BOWL (Silver)" },
            { value: "BRACELET", text: "BRACELET (Gold)" },
            { value: "BRACELET-silver", text: "BRACELET (Silver)" },
            { value: "CHAIN", text: "CHAIN (Gold)" },
            { value: "CHAIN-silver", text: "CHAIN (Silver)" },
            { value: "DEEPA", text: "DEEPA (Silver)" },
            { value: "EARRINGS", text: "EARRINGS" },
            { value: "FLOWER BASKET", text: "FLOWER BASKET (Silver)" },
            { value: "HARA", text: "HARA" },
            { value: "JHUMKI", text: "JHUMKI" },
            { value: "KADA", text: "KADA (Silver)" },
            { value: "KALASA", text: "KALASA (Silver)" },
            { value: "MANGAL SUTRA", text: "MANGAL SUTRA" },
            { value: "NECKLACE", text: "NECKLACE" },
            { value: "NOSEPIN", text: "NOSEPIN" },
            { value: "PAYAL", text: "PAYAL (Silver)" },
            { value: "PENDANT", text: "PENDANT" },
            { value: "PLATE", text: "PLATE (Silver)" },
            { value: "RING", text: "RING" },
            { value: "STUDS", text: "STUDS" },
            { value: "TUMBLER", text: "TUMBLER (Silver)" },
            { value: "other-jewellery", text: "Jewellery - Other (Specify)" },
            { value: "other-silver", text: "Silver - Other (Specify)" }
        ].sort((a, b) => a.text.localeCompare(b.text)); // Sort alphabetically by text

        const purityOptions = [
            { value: "G - 18K(75)", text: "G - 18K(75)" },
            { value: "G - 20K(833)", text: "G - 20K(833)" },
            { value: "G - 22K(916)", text: "G - 22K(916)" },
            { value: "G - Others", text: "G - Others" },
            { value: "S - Sterling", text: "S - Sterling" },
            { value: "Silver", text: "Silver" }
        ].sort((a, b) => a.text.localeCompare(b.text)); // Sort alphabetically

        // --- FUNCTION TO POPULATE DROPDOWNS ---
        function populateDropdown(selectElement, optionsArray) {
             // Keep the initial default option
            optionsArray.forEach(optionData => {
                const option = document.createElement('option');
                option.value = optionData.value;
                option.textContent = optionData.text;
                selectElement.appendChild(option);
            });
        }

        // --- CALCULATIONS & DISPLAY ---
        function calculateTotalAndUpdateDisplay() {
            const formData = getFormData();
            const q = +formData.rawQuantity || 0;
            const r = +formData.rawRate || 0;
            const mc = +formData.rawMakingCharges || 0;
            const s = +formData.rawStoneCharges || 0;
            let t = 0;
            if (formData.mcType === "grams") {
                t = ((q + mc) * r + s) * 1.03;
            } else {
                t = (((q + (q * (mc / 100))) * r) + s) * 1.03;
            }
            elements.finalTotal.textContent = `₹ ${t.toFixed(2)}`;
        }

        // --- DATA HANDLING ---
        function getFormData() {
            const categoryValue = elements.ornamentCategory.value;
            let finalOrnamentName = categoryValue;
            const selectedOption = elements.ornamentCategory.options[elements.ornamentCategory.selectedIndex];
             if (selectedOption && !categoryValue.startsWith('other-')) {
                 finalOrnamentName = selectedOption.text; // Use display text
             } else if (categoryValue === 'other-jewellery' || categoryValue === 'other-silver') {
                finalOrnamentName = elements.ornamentOther.value || `Other ${categoryValue.includes('jewellery') ? 'Jewellery' : 'Silver'}`;
            }

            // Get Purity Text
            const puritySelect = elements.purity;
            const selectedPurityOption = puritySelect.options[puritySelect.selectedIndex];
            // Use the value if it's not the placeholder, otherwise empty string
            const purityText = (selectedPurityOption && puritySelect.value) ? selectedPurityOption.text : "";


            return {
                estimationId: estimationId,
                employeeName: JSON.parse(userJSON).name,
                customerName: document.getElementById('customerName').value,
                mobileNumber: document.getElementById('mobileNumber').value,
                city: document.getElementById('city').value,
                panNumber: document.getElementById('panNumber').value.toUpperCase(),
                ornament: finalOrnamentName,
                purity: purityText, // Add purity text
                rawRate: document.getElementById('rate').value || '0',
                rawQuantity: document.getElementById('quantity').value || '0',
                mcType: document.querySelector('input[name="mcType"]:checked').value,
                rawMakingCharges: document.getElementById('makingCharges').value || '0',
                rawStoneCharges: document.getElementById('stoneCharges').value || '0',
                rate: document.getElementById('rate').value || '0',
                quantity: document.getElementById('quantity').value || '0',
                makingCharges: document.getElementById('makingCharges').value || '0',
                stoneCharges: document.getElementById('stoneCharges').value || '0',
            };
        }

        // --- ORNAMENT DROPDOWN LOGIC ---
        elements.ornamentCategory.addEventListener('change', () => {
             const selectedValue = elements.ornamentCategory.value;
             if (selectedValue === 'other-jewellery' || selectedValue === 'other-silver') {
                 elements.ornamentOther.classList.add('visible');
                 elements.ornamentOtherLabel.style.display = 'block';
                 elements.ornamentOther.required = true;
                 elements.ornamentOther.focus();
             } else {
                 elements.ornamentOther.classList.remove('visible');
                 elements.ornamentOtherLabel.style.display = 'none';
                 elements.ornamentOther.required = false;
                 elements.ornamentOther.value = ''; // Clear if hidden
             }
        });


        // --- NEW SIMPLIFIED BUTTON STATE & EVENT HANDLERS ---
        function setButtonState(state) {
            elements.actionButtons.innerHTML = ''; // Clear existing buttons

            if (state === 'new') {
                elements.actionButtons.innerHTML = `<button type="submit" id="saveBtn" form="estimation-form">Save Estimate</button>`;

            } else if (state === 'saved') {
                elements.actionButtons.innerHTML = `<button type="button" id="printBtn">Print</button>`;
                document.getElementById('printBtn').addEventListener('click', handlePrint);

            } else if (state === 'printed') {
                elements.actionButtons.innerHTML = `
                    <button type="button" id="newSlipBtn">New Slip</button>
                    <button type="button" id="restoreBtn">Restore Last Entry</button>`;
                document.getElementById('newSlipBtn').addEventListener('click', resetForm);
                document.getElementById('restoreBtn').addEventListener('click', handleRestore);

            } else if (state === 'restored') {
                elements.actionButtons.innerHTML = `
                    <button type="button" id="printBtn">Print Restored</button>
                    <button type="button" id="newSlipBtn">New Slip</button>`;
                document.getElementById('printBtn').addEventListener('click', handlePrint);
                document.getElementById('newSlipBtn').addEventListener('click', resetForm);
            }
        }

        elements.logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('employeeUser');
            localStorage.removeItem('lastEntry');
            window.location.href = 'index.html'; // Fixed: Use root-relative path
        });

        form.addEventListener('input', calculateTotalAndUpdateDisplay);

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            // Ensure 'Other' field is filled if selected
            const categoryValue = elements.ornamentCategory.value;
             if ((categoryValue === 'other-jewellery' || categoryValue === 'other-silver') && !elements.ornamentOther.value.trim()) {
                 alert('Please specify the ornament name in the "Specify Ornament" field.');
                 elements.ornamentOther.focus();
                 return; // Stop submission
             }


            const saveBtn = document.getElementById('saveBtn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            const formData = getFormData(); // Get data *after* validation
            const totalAmount = parseFloat(elements.finalTotal.textContent.replace('₹ ', '')).toFixed(2);
            // Prepare data for saving (exclude raw calculation values)
            const dataToSave = {
                estimationId: formData.estimationId,
                employeeName: formData.employeeName,
                customerName: formData.customerName,
                mobileNumber: formData.mobileNumber,
                city: formData.city,
                panNumber: formData.panNumber,
                ornament: formData.ornament,
                purity: formData.purity, // Include purity
                rate: formData.rate,
                quantity: formData.quantity,
                mcType: formData.mcType,
                makingCharges: formData.makingCharges,
                stoneCharges: formData.stoneCharges,
                totalAmount: totalAmount
             };


            localStorage.setItem('lastEntry', JSON.stringify(dataToSave));

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave) // Send cleaned data
            }).then(() => {
                setButtonState('saved'); // Go to 'saved' state
                alert('Estimation saved successfully!');
            }).catch(error => {
                console.error('Error:', error);
                alert('Failed to save estimation.');
                // Re-enable save button only if save failed
                saveBtn.textContent = 'Save Estimate';
                saveBtn.disabled = false;
            });
        });

        function handlePrint() {
            populatePrintSlip(getFormData()); // Use current form data for print
            window.print();
            setButtonState('printed'); // Go to 'printed' state after print
        }

        function handleRestore() {
            const lastEntry = JSON.parse(localStorage.getItem('lastEntry'));
            if (lastEntry) {
                populateForm(lastEntry);
                calculateTotalAndUpdateDisplay(); // Update total display
                setButtonState('restored'); // Go to 'restored' state
            } else {
                alert("No entry to restore.");
            }
        }

        function populateForm(data) {
            estimationId = data.estimationId; // Restore the ID
            document.getElementById('customerName').value = data.customerName;
            document.getElementById('mobileNumber').value = data.mobileNumber;
            document.getElementById('city').value = data.city;
            document.getElementById('panNumber').value = data.panNumber;

            // Ornament handling
            const ornamentSelect = elements.ornamentCategory;
            const otherInput = elements.ornamentOther;
            let foundOption = false;
            for (let i = 0; i < ornamentSelect.options.length; i++) {
                if (ornamentSelect.options[i].text === data.ornament) {
                    ornamentSelect.value = ornamentSelect.options[i].value;
                    foundOption = true;
                    break;
                }
            }
            if (foundOption && !ornamentSelect.value.startsWith('other-')) {
                 otherInput.classList.remove('visible');
                 elements.ornamentOtherLabel.style.display = 'none';
                 otherInput.required = false;
                 otherInput.value = '';
            } else {
                 // Try to guess 'other' type based on saved text if possible
                 let otherType = 'other-jewellery'; // Default guess
                 if (data.ornament && (data.ornament.toLowerCase().includes('silver') || ['plate', 'tumbler', 'kalasa', 'deepa', 'bowl', 'flower basket', 'payal', 'kada'].includes(data.ornament.toUpperCase()))) {
                      otherType = 'other-silver';
                 }
                 ornamentSelect.value = otherType; // Select the 'other' option
                 otherInput.value = data.ornament; // Put the actual saved name here
                 otherInput.classList.add('visible');
                 elements.ornamentOtherLabel.style.display = 'block';
                 otherInput.required = true;
            }

             // Purity handling
            const puritySelect = elements.purity;
            let foundPurity = false;
            // Use saved data.purity (which is the text) to find the matching option value
            const savedPurityText = data.purity || "";
             for (let i = 0; i < puritySelect.options.length; i++) {
                 if (puritySelect.options[i].text === savedPurityText) {
                      puritySelect.value = puritySelect.options[i].value;
                      foundPurity = true;
                      break;
                 }
             }
             if (!foundPurity) {
                 puritySelect.value = ""; // Default if saved purity not in options
             }


            document.getElementById('rate').value = data.rate;
            document.getElementById('quantity').value = data.quantity;
            document.querySelector(`input[name="mcType"][value="${data.mcType}"]`).checked = true;
            document.getElementById('makingCharges').value = data.makingCharges;
            document.getElementById('stoneCharges').value = data.stoneCharges;
        }

        function populatePrintSlip(data) {
            const maskedMobile = data.mobileNumber ? 'x'.repeat(Math.max(0, data.mobileNumber.length - 3)) + data.mobileNumber.slice(-3) : '';
            const total = parseFloat(elements.finalTotal.textContent.replace('₹ ', '')).toFixed(2);
            // Use the data.purity (which is the display text) directly
            const purityDisplay = data.purity ? data.purity : '';

            const slipHTML = `
                <div class="print-header">
                    <h3>Keshava Jewellers, Sagara</h3>
                    <p>elv8.works</p>
                    <div class="divider"></div>
                    <h4>Estimation Slip</h4>
                    <div class="divider"></div>
                </div>
                <div class="print-main">
                    <div class="print-row"><span class="label">Employee:</span><span class="value">${data.employeeName}</span></div>
                    <div class="print-row"><span class="label">Customer:</span><span class="value">${data.customerName}</span></div>
                    <div class="print-row"><span class="label">City:</span><span class="value">${data.city || ''}</span></div>
                    <div class="print-row"><span class="label">Mobile:</span><span class="value">${maskedMobile.replace(/x/g, '')}</span></div>
                    <div class="print-row"><span class="label">Ornament:</span><span class="value">${data.ornament}</span></div>
                    ${purityDisplay ? `<div class="print-row"><span class="label">Purity:</span><span class="value">${purityDisplay}</span></div>` : ''}
                    <div class="print-row"><span class="label">Quantity:</span><span class="value">${data.quantity} gms</span></div>
                    <div class="print-row"><span class="label">Rate:</span><span class="value">${data.rate}</span></div>
                    <div class="print-row"><span class="label">Making Charges:</span><span class="value">${data.makingCharges} ${data.mcType === 'grams' ? 'gms' : '%'}</span></div>
                    <div class="print-row"><span class="label">Stone Charges:</span><span class="value">${data.stoneCharges}</span></div>
                    <div class="print-row total-row"><span class="label">Total Estimated Cost:</span><span class="value">₹ ${total}</span></div>
                    <div class="print-row"><span class="label">Estimation ID:</span><span class="value">${data.estimationId}</span></div>
                </div>
                <div class="print-footer">
                    <p>Note: This estimated cost is valid for 24 hours.</p>
                </div>
            `;
            elements.printSlipContainer.innerHTML = slipHTML;
        }

        function resetForm() {
            form.reset();
            estimationId = Math.floor(10000 + Math.random() * 90000);
            document.getElementById('customerName').focus();
             // Hide 'Other' ornament field on reset
             elements.ornamentOther.classList.remove('visible');
             elements.ornamentOtherLabel.style.display = 'none';
             elements.ornamentOther.required = false;
            setButtonState('new'); // Set to initial 'new' state
            calculateTotalAndUpdateDisplay();
        }

        // --- INITIALIZE APP ---
        window.addEventListener('DOMContentLoaded', () => {
             populateDropdown(elements.ornamentCategory, ornamentOptions);
             populateDropdown(elements.purity, purityOptions);
             resetForm();
        });
    </script>
</body>
</html>

