<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keshava Jewellers - Estimation Form</title>
<style>
body {
  font-family: "Inter", sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 700px;
  margin: 40px auto;
  background: #fff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.logo { text-align: center; margin-bottom: 10px; }
.logo img { width: 100px; }
h1, h3 { text-align: center; margin: 5px 0; }

label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
input, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 15px; text-align: left; }
.radio-group { display: flex; gap: 15px; justify-content: flex-start; margin-bottom: 15px; }
button { width: 48%; padding: 12px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; position: relative; }
.save-btn { background-color: #4f46e5; color: white; }
.save-btn:hover { background: #4338ca; }
#printBtn { background-color: gray; opacity: 0.6; cursor: not-allowed; }
#printBtn.active { background-color: #007bff; opacity: 1; cursor: pointer; }
#restoreBtn { background-color: #22c55e; color:white; }

/* Print layout */
@media print {
  body { background: white; margin: 0; }
  .container { width: 80mm; padding: 10px; margin: 0 auto; box-shadow: none; border-radius: 0; text-align: left; }
  .btn-container, .radio-group, input, select { display: none !important; }
  .print-row { display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px dashed #ccc; padding: 2px 0; }
  .logo img { width: 50px; }
  h1, h3 { text-align: center; font-size: 13px; margin: 2px 0; }
  @page { size: 80mm auto; margin: 3mm; }
}
</style>
</head>
<body>

<div class="container" id="estimationContainer">
  <div class="logo"><img src="kc.png" alt="Logo"></div>
  <h1>Keshava Jewellers, Sagara</h1>
  <h3>Estimation Slip</h3>

  <form id="estimationForm">
    <label>Employee Name*</label>
    <input type="text" id="employeeName" readonly>

    <label>Customer Name*</label>
    <input type="text" id="customerName" required>

    <label>Mobile Number</label>
    <input type="text" id="mobileNumber">

    <label>City</label>
    <input type="text" id="city">

    <label>PAN Number (Optional)</label>
    <input type="text" id="panNumber" placeholder="ABCDE1234F">

    <label>Ornament Chosen</label>
    <input type="text" id="ornament">

    <label>Quantity (gms)</label>
    <input type="number" id="quantity" step="0.01">

    <label>Rate (per gm)</label>
    <input type="number" id="rate" step="0.01">

    <div class="radio-group">
      <label><input type="radio" name="mcType" value="grams" checked> MC in grams</label>
      <label><input type="radio" name="mcType" value="percent"> MC in %</label>
    </div>

    <label>Making Charges</label>
    <input type="number" id="makingCharges" step="0.01">

    <label>Stone Charges</label>
    <input type="number" id="stoneCharges" step="0.01">

    <label>Total Amount</label>
    <input type="text" id="amount" readonly style="background:#f9fafb;font-weight:bold;">

    <div class="btn-container" style="text-align:center;">
      <button type="button" class="save-btn" id="saveBtn">Save</button>
      <button type="button" id="printBtn" disabled>Print</button>
      <button type="reset">Reset</button>
      <button type="button" id="restoreBtn">Restore Last Entry</button>
    </div>
  </form>

  <div id="printSection" style="display:none;">
    <div class="logo"><img src="kc.png" alt="Logo"></div>
    <h1>Keshava Jewellers, Sagara</h1>
    <h3>Estimation Slip</h3>
    <div id="printContent"></div>
    <div class="footer-note" style="font-size:11px; text-align:center; margin-top:5px;">Note: This estimated cost is valid for 24 hours.</div>
  </div>
</div>

<script>
/* -------------------------------
   LOGIN VALIDATION
--------------------------------*/
const loginTime = localStorage.getItem("loginTime");
const employeeEmail = localStorage.getItem("employeeEmail");
if(!employeeEmail || !loginTime || (Date.now() - loginTime > 24*60*60*1000)){
  alert("You are not logged in. Please login first.");
  window.location.href = "index.html";
}
document.getElementById("employeeName").value = employeeEmail.split("@")[0];

/* -------------------------------
   FIELD CALCULATIONS
--------------------------------*/
const quantity=document.getElementById("quantity");
const rate=document.getElementById("rate");
const makingCharges=document.getElementById("makingCharges");
const stoneCharges=document.getElementById("stoneCharges");
const amount=document.getElementById("amount");
const mcTypeRadios=document.getElementsByName("mcType");

function calculateTotal(){
  const qty=parseFloat(quantity.value)||0;
  const rt=parseFloat(rate.value)||0;
  const mc=parseFloat(makingCharges.value)||0;
  const stone=parseFloat(stoneCharges.value)||0;
  const mcType=[...mcTypeRadios].find(r=>r.checked)?.value;
  let total=0;
  if(mcType==="grams") total=((qty+mc)*rt+stone)*1.03;
  else total=(((qty+(qty*(mc/100)))*rt)+stone)*1.03;
  amount.value=total.toFixed(2);
}
[quantity,rate,makingCharges,stoneCharges].forEach(el=>el.addEventListener("input",calculateTotal));
mcTypeRadios.forEach(r=>r.addEventListener("change",calculateTotal));

/* -------------------------------
   PAN VALIDATION FUNCTION
--------------------------------*/
function isValidPAN(pan){
  return /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(pan);
}

/* -------------------------------
   MASKING FUNCTIONS
--------------------------------*/
function maskNumber(number, visibleDigits=4){
  number = number || '';
  if(number.length <= visibleDigits) return number;
  return '*'.repeat(number.length-visibleDigits) + number.slice(-visibleDigits);
}
function maskPAN(pan, visibleDigits=3){
  pan = pan || '';
  if(pan.length <= visibleDigits) return pan;
  return '*'.repeat(pan.length-visibleDigits) + pan.slice(-visibleDigits);
}

/* -------------------------------
   SAVE & GOOGLE SHEET INTEGRATION
--------------------------------*/
const saveBtn=document.getElementById("saveBtn");
const printBtn=document.getElementById("printBtn");
const restoreBtn=document.getElementById("restoreBtn");

let lastSavedData = null; // store latest entry

function generateUniqueID(){ return "EST-"+Date.now(); }

saveBtn.addEventListener("click", async () => {
  const data = {
    employeeName: document.getElementById("employeeName").value,
    customerName: document.getElementById("customerName").value.trim(),
    mobileNumber: document.getElementById("mobileNumber").value.trim(),
    city: document.getElementById("city").value.trim(),
    panNumber: document.getElementById("panNumber").value.trim().toUpperCase(),
    ornament: document.getElementById("ornament").value.trim(),
    quantity: quantity.value,
    rate: rate.value,
    mcType: [...mcTypeRadios].find(r => r.checked)?.value,
    makingCharges: makingCharges.value,
    stoneCharges: stoneCharges.value,
    amount: parseFloat(amount.value) || 0
  };

  if(!data.customerName){ alert("Customer Name is mandatory!"); return; }
  if(data.panNumber && !isValidPAN(data.panNumber)){
    alert("Invalid PAN format! Example: ABCDE1234F"); return;
  }

  // Change button text to Saving
  saveBtn.disabled = true;
  saveBtn.textContent = "Saving...";

  try {
    const MAX=199000;
    let remaining=data.amount;
    let baseID=generateUniqueID();
    const splitEntries=[];

    if(remaining<=MAX || data.panNumber){
      splitEntries.push({...data, estimationID: baseID});
    } else {
      let i=0;
      while(remaining>0){
        let entryAmt=remaining>MAX?MAX:remaining;
        splitEntries.push({...data, amount:entryAmt, estimationID:baseID+"-"+(i+1)});
        remaining-=entryAmt; i++;
      }
    }

    // Google Apps Script endpoint
    const scriptURL="https://script.google.com/macros/s/AKfycbw19fcF57d173j9Bhm5v1yc2ehoL-kQCgF4RABNL_DJhRsz_kRGnbb5XE0yO5Yeg9VwAA/exec";

    await fetch(scriptURL,{
      method:"POST",
      body:JSON.stringify({entries:splitEntries})
    });

    alert("Saved successfully!");
    printBtn.disabled=false;
    printBtn.classList.add("active");
    saveBtn.style.display = "none"; // remove save button after save

    lastSavedData = {...data}; // store latest saved entry

    // Zoho integration placeholder
    sendToZoho(data);

    // Prepare print content (masked)
    const mcSuffix = data.mcType==="grams" ? "gms" : "%";
    const printHTML=`
      <div class='print-row'><strong>Employee:</strong><span>${data.employeeName}</span></div>
      <div class='print-row'><strong>Customer:</strong><span>${data.customerName}</span></div>
      <div class='print-row'><strong>City:</strong><span>${data.city}</span></div>
      <div class='print-row'><strong>Mobile:</strong><span>${maskNumber(data.mobileNumber)}</span></div>
      <div class='print-row'><strong>PAN:</strong><span>${maskPAN(data.panNumber)}</span></div>
      <div class='print-row'><strong>Ornament:</strong><span>${data.ornament}</span></div>
      <div class='print-row'><strong>Quantity:</strong><span>${data.quantity} gms</span></div>
      <div class='print-row'><strong>Rate:</strong><span>${data.rate}</span></div>
      <div class='print-row'><strong>VA (Making Charges ${mcSuffix}):</strong><span>${data.makingCharges}</span></div>
      <div class='print-row'><strong>Stone Charges:</strong><span>${data.stoneCharges}</span></div>
      <div class='print-row'><strong>Total Amount:</strong><span>â‚¹ ${data.amount.toFixed(2)}</span></div>
      <div class='print-row'><strong>Estimation ID:</strong><span>${baseID}</span></div>
    `;
    document.getElementById("printContent").innerHTML = printHTML;

  } catch(err){
    console.error(err);
    alert("Error saving!");
    saveBtn.disabled = false;
    saveBtn.textContent = "Save";
  }
});

/* -------------------------------
   ZOHO INTEGRATION PLACEHOLDER
--------------------------------*/
function sendToZoho(data){
  const ZOHO_API_URL = "https://creator.zoho.in/api/v2/your_app/report/addRecord";
  const payload = {
    data: {
      Employee_Name: data.employeeName,
      Customer_Name: data.customerName,
      City: data.city,
      Mobile: data.mobileNumber,
      Amount: data.amount
    }
  };
  console.log("Zoho payload ready:", payload);
  // Implement fetch with Authorization header later
}

/* -------------------------------
   PRINT FUNCTION (MOBILE SAFE)
--------------------------------*/
printBtn.addEventListener("click",()=>{
  const printSection = document.getElementById("printSection");
  printSection.style.display = "block";

  window.print();

  printSection.style.display = "none";

  // Reset form after print
  document.getElementById("estimationForm").reset();
  printBtn.disabled = true;
  printBtn.classList.remove("active");
  saveBtn.style.display = "inline-block";
});

/* -------------------------------
   RESTORE LAST ENTRY
--------------------------------*/
restoreBtn.addEventListener("click", ()=>{
  if(!lastSavedData) return alert("No saved entry found!");
  document.getElementById("customerName").value = lastSavedData.customerName;
  document.getElementById("mobileNumber").value = lastSavedData.mobileNumber;
  document.getElementById("city").value = lastSavedData.city;
  document.getElementById("panNumber").value = lastSavedData.panNumber;
  document.getElementById("ornament").value = lastSavedData.ornament;
  document.getElementById("quantity").value = lastSavedData.quantity;
  document.getElementById("rate").value = lastSavedData.rate;
  document.getElementById("makingCharges").value = lastSavedData.makingCharges;
  document.getElementById("stoneCharges").value = lastSavedData.stoneCharges;

  [...mcTypeRadios].forEach(r => r.checked = (r.value === lastSavedData.mcType));
  calculateTotal();
});
</script>

</body>
</html>
