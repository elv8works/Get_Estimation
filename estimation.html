<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Keshava Jewellers Estimation</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#fff;}
.container{padding:10px;max-width:400px;margin:auto;}
input,select,button{width:100%;padding:6px;margin:4px 0;border:1px solid #ccc;border-radius:5px;font-size:14px;}
button{background:#007bff;color:#fff;border:none;cursor:pointer;}
button:disabled{opacity:.5;cursor:not-allowed;}
.hidden{display:none;}
#printSection{display:none;}
@media print{
 body{margin:0;padding:0;width:80mm;}
 .container{display:none;}
 #printSection{display:block;width:80mm;font-size:11px;}
}
</style>
</head>
<body>

<div class="container">
  <h2 style="text-align:center;">Keshava Jewellers Estimation</h2>

  <form id="estimationForm">
    <label>Employee Name</label><input id="employeeName" required>
    <label>Customer Name</label><input id="customerName" required>
    <label>City</label><input id="city">

    <label>Mobile Number</label><input id="mobileNumber" maxlength="10" pattern="[0-9]{10}" required>
    <label>PAN Number</label><input id="panNumber" maxlength="10">

    <label>Ornament</label><input id="ornament">
    <label>Quantity (gms)</label><input type="number" id="quantity" step="0.01">
    <label>Rate</label><input type="number" id="rate" step="0.01">

    <label>Making Charges Type</label>
    <div>
      <input type="radio" name="mcType" value="grams" checked> gms
      <input type="radio" name="mcType" value="percent"> %
    </div>

    <label>Making Charges</label><input type="number" id="makingCharges" step="0.01">
    <label>Stone Charges</label><input type="number" id="stoneCharges" step="0.01">
    <label>Total Amount</label><input id="amount" readonly>

    <button type="button" id="saveBtn">Save</button>
    <button type="button" id="printBtn" disabled>Print</button>
    <button type="button" id="restoreBtn">Restore Last</button>
  </form>
</div>

<div id="printSection"></div>

<script>
// -------- helpers ----------
function maskNumber(num){return num?num.replace(/\d(?=\d{4})/g,"*"):'';}
function maskPAN(pan){return pan?pan.replace(/.(?=.{3}$)/g,"*"):'';}

let lastSavedData=null;

// -------- calc total ----------
function calcTotal(){
  const q=+quantity.value||0, r=+rate.value||0, mc=+makingCharges.value||0, s=+stoneCharges.value||0;
  const mcType=document.querySelector('input[name="mcType"]:checked').value;
  let t=0;
  if(mcType==="grams") t=((q+mc)*r+s)*1.03;
  else t=(((q+(q*(mc/100)))*r)+s)*1.03;
  amount.value=t.toFixed(2);
}
["quantity","rate","makingCharges","stoneCharges"].forEach(id=>{
  document.getElementById(id).addEventListener("input",calcTotal);
});
document.querySelectorAll('input[name="mcType"]').forEach(r=>r.addEventListener("change",calcTotal));

// -------- save ----------
saveBtn.onclick=()=>{
  saveBtn.textContent="Saving...";
  saveBtn.disabled=true;

  const data={
    employeeName:employeeName.value,
    customerName:customerName.value,
    city:city.value,
    mobileNumber:mobileNumber.value,
    panNumber:panNumber.value,
    ornament:ornament.value,
    quantity:+quantity.value||0,
    rate:+rate.value||0,
    mcType:document.querySelector('input[name="mcType"]:checked').value,
    makingCharges:+makingCharges.value||0,
    stoneCharges:+stoneCharges.value||0,
    amount:+amount.value||0,
    estimationID:"EST"+Date.now()
  };

  lastSavedData=data;
  localStorage.setItem("lastEstimation",JSON.stringify(data));

  setTimeout(()=>{
    saveBtn.style.display="none";
    printBtn.disabled=false;
    alert("Saved successfully!");
  },500);
};

// -------- restore ----------
restoreBtn.onclick=()=>{
  const d=localStorage.getItem("lastEstimation");
  if(!d) return alert("No previous entry found");
  const data=JSON.parse(d);
  employeeName.value=data.employeeName;
  customerName.value=data.customerName;
  city.value=data.city;
  mobileNumber.value=data.mobileNumber;
  panNumber.value=data.panNumber;
  ornament.value=data.ornament;
  quantity.value=data.quantity;
  rate.value=data.rate;
  makingCharges.value=data.makingCharges;
  stoneCharges.value=data.stoneCharges;
  amount.value=data.amount;
  document.querySelector(`input[name="mcType"][value="${data.mcType}"]`).checked=true;
  lastSavedData=data;
  printBtn.disabled=false;
  saveBtn.style.display="none";
  alert("Restored last entry (not saved again)");
};

// -------- print ----------
printBtn.onclick=()=>{
  if(!lastSavedData) return alert("Please save first!");
  const d=lastSavedData, mcSuffix=d.mcType==="grams"?"gms":"%";
  const html=`
    <div style="text-align:center;">
      <img src="kc.png" style="width:45px;"><br>
      <strong style="font-size:13px;">Keshava Jewellers, Sagara</strong><br>
      <span style="font-size:11px;">Estimation Slip</span>
    </div>
    <div style="font-size:11px;margin-top:4px;">
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Employee:</strong><span>${d.employeeName}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Customer:</strong><span>${d.customerName}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>City:</strong><span>${d.city}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Mobile:</strong><span>${maskNumber(d.mobileNumber)}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>PAN:</strong><span>${maskPAN(d.panNumber)}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Ornament:</strong><span>${d.ornament}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Qty:</strong><span>${d.quantity} gms</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Rate:</strong><span>${d.rate}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>VA (Making ${mcSuffix}):</strong><span>${d.makingCharges}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Stone Charges:</strong><span>${d.stoneCharges}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>Total Amount:</strong><span>â‚¹ ${d.amount.toFixed(2)}</span></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px dashed #000;"><strong>ID:</strong><span>${d.estimationID}</span></div>
    </div>
    <div style="text-align:center;font-size:9px;margin-top:5px;">Note: This estimated cost is valid for 24 hours.</div>
  `;
  const ps=document.getElementById("printSection");
  ps.innerHTML=html; ps.style.display="block";
  window.print();
  ps.style.display="none";
  document.getElementById("estimationForm").reset();
  saveBtn.style.display="inline-block";
  printBtn.disabled=true;
};
</script>
</body>
</html>
