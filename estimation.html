<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Estimation - Keshava Jewellers</title>
    <style>
        /* === KESHAVA JEWELLERS - MOBILE-FIRST MIDNIGHT GOLD THEME === */

        /* 1. Theme Variables & Global Styles */
        :root {
            --gold: #D4AF37;
            --dark-gold: #b98d28;
            --navy-dark: #0d1a26;
            --navy-medium: #1a2f40;
            --navy-light: #2a4a69;
            --text-light: #c5d1e0;
            --text-white: #ffffff;
            --font-serif: 'Georgia', 'Times New Roman', serif;
            --font-sans: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background-color: var(--navy-dark);
            color: var(--text-light);
            margin: 0;
            padding: 1rem;
        }

        /* 2. Main App Layout & Styles */
        .app-container {
            width: 100%;
            max-width: 600px; /* Optimal for mobile and desktop viewing */
            margin: 0 auto;
        }

        .form-panel { 
            padding: 1.5rem; 
            background: var(--navy-medium); 
            border-radius: 12px; 
            border: 1px solid var(--navy-light);
        }

        .app-header { 
            display: flex; 
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--navy-light); 
            padding-bottom: 1rem; 
            margin-bottom: 1.5rem; 
            gap: 1rem;
        }
        .app-header h2 { 
            color: var(--text-white); 
            font-weight: 500; 
            margin: 0; 
            flex-basis: 100%; /* Title takes full width */
            text-align: center;
        }
        .header-buttons { 
            display: flex; 
            gap: 1rem;
            width: 40%;
            justify-content: right;
        }
        #export-btn, #logout-btn { 
            background: var(--navy-light); 
            color: var(--text-light); 
            border: none; 
            padding: 0.6rem 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.9rem;
            flex-grow: 1; /* Buttons share space */
        }
        #export-btn:hover, #logout-btn:hover { 
            background: var(--gold); 
            color: var(--navy-dark); 
        }

        .gold-rate-widget { 
            background: var(--navy-dark); 
            padding: 1rem; 
            border-radius: 8px; 
            margin-bottom: 2rem; 
        }
        .rate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .rate-header span {
            font-weight: bold;
            color: var(--text-white);
        }
        #refresh-rate-btn {
             background: var(--navy-light); 
            color: var(--text-light); 
            border: none; 
            padding: 0.5rem 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .rate-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        .rate-entry + .rate-entry {
            border-top: 1px solid var(--navy-light);
        }
        .rate-details {
            font-size: 1.1rem;
        }
        .rate-details strong {
            color: var(--gold);
        }
        .use-rate-btn {
            background: transparent;
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .use-rate-btn:hover {
            background: var(--gold);
            color: var(--navy-dark);
        }

        .form-section { 
            margin-bottom: 2rem; 
        }
        .form-section h3 { 
            font-family: var(--font-serif); 
            color: var(--gold); 
            border-bottom: 1px solid var(--navy-light); 
            padding-bottom: 0.5rem; 
            margin-bottom: 1.5rem; 
            font-weight: 500; 
        }

        label { 
            display: block; 
            margin-bottom: 0.5rem; 
        }
        input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--navy-dark);
            border: 1px solid var(--navy-light);
            color: var(--text-white);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .radio-group { 
            display: flex; 
            gap: 1.5rem; 
            margin-top: 0.5rem; 
        }
        .radio-group input { 
            display: none; 
        }
        .radio-group label { 
            position: relative; 
            padding-left: 25px; 
            cursor: pointer; 
        }
        .radio-group label::before, .radio-group label::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .radio-group label::before { 
            left: 0; 
            top: 2px; 
            width: 16px; 
            height: 16px; 
            border: 2px solid var(--navy-light); 
        }
        .radio-group label::after { 
            left: 5px; 
            top: 7px; 
            width: 8px; 
            height: 8px; 
            background: var(--gold); 
            opacity: 0; 
            transform: scale(0); 
        }
        .radio-group input:checked + label::before { 
            border-color: var(--gold); 
        }
        .radio-group input:checked + label::after { 
            opacity: 1; 
            transform: scale(1); 
        }
        
        .total-display { 
            background: var(--gold); 
            color: var(--navy-dark); 
            padding: 1rem; 
            text-align: center; 
            border-radius: 8px; 
            margin-top: 1rem; 
        }
        .total-display small { 
            display: block; 
            opacity: 0.8; 
        }
        .total-display strong { 
            font-size: 2rem; 
        }
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin-top: 1.5rem; 
        }
        .action-buttons button { 
            width: 100%; 
            padding: 0.9rem; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: bold;
            font-size: 1rem;
        }
        #saveBtn { 
            background: var(--gold); 
            color: var(--navy-dark); 
            grid-column: 1 / -1; /* Span full width */
        }
        #printBtn, #restoreBtn, #newSlipBtn { 
            background: var(--navy-light); 
            color: var(--text-light); 
        }
        #printBtn:disabled, #restoreBtn:disabled { 
            background: var(--navy-medium); 
            color: #555; 
            cursor: not-allowed; 
        }

        /* 5. PERFECTED PRINT STYLES */
        .print-only { 
            display: none; 
        }
        @page { 
            size: 80mm auto; /* Set paper width, height is automatic */
            margin: 0; 
        }
        @media print {
            html, body { 
                width: 80mm;
                height: auto;
                background: none;
                margin: 0;
                padding: 0;
                overflow: visible;
            }
            body * { 
                visibility: hidden; 
            }
            .print-only, .print-only * { 
                visibility: visible; 
            }
            .print-only { 
                display: block;
                position: static; /* Use static for natural flow */
                width: 100%;
                margin: 0;
                padding: 5mm; /* Add some padding for the printer */
            }
            
            .print-header, .print-main, .print-footer { 
                color: #000; 
                font-family: 'Courier New', monospace;
                font-size: 10pt; 
            }
            .print-header { text-align: center; margin-bottom: 10px; }
            .print-header h3 { font-size: 12pt; margin: 0; }
            .print-header p, .print-header h4 { margin: 2px 0; }
            .divider { border-bottom: 1px dashed #000; margin: 5px 0; }
            .print-main { margin-bottom: 10px; }
            .print-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
            .print-row .label { font-weight: bold; white-space: nowrap; padding-right: 5px; }
            .print-row .value { text-align: right; }
            .total-row { font-weight: bold; margin-top: 10px; }
            .print-footer { text-align: center; font-size: 8pt; border-top: 1px dashed #000; padding-top: 5px; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="form-panel">
            <header class="app-header">
                <h2>Keshava Jewellers</h2>
                <div class="header-buttons">
                    <!-- <button id="export-btn">Export as CSV</button> -->
                    <button id="logout-btn">Logout</button>
                </div>
            </header>

            <!-- <section class="gold-rate-widget">
                <div class="rate-header">
                    <span>Today's Gold Rate (/gm)</span>
                    <button id="refresh-rate-btn">Refresh</button>
                </div>
                <div id="rates-container">
                    
                </div>
            </section> -->

            <form id="estimation-form">
                <section class="form-section">
                    <h3>Customer Details</h3>
                    <label for="customerName">Customer Name*</label>
                    <input type="text" id="customerName" required>
                    <label for="mobileNumber">Mobile Number</label>
                    <input type="tel" id="mobileNumber" maxlength="10">
                    <label for="city">City</label>
                    <input type="text" id="city">
                    <label for="panNumber">PAN Number</label>
                    <input type="text" id="panNumber" maxlength="10">
                </section>

                <section class="form-section">
                    <h3>Ornament Details</h3>
                    <label for="ornament">Ornament*</label>
                    <input type="text" id="ornament" required>
                    <label for="rate">Gold Rate (per gram)*</label>
                    <input type="number" id="rate" required>
                    <label for="quantity">Quantity (in gms)*</label>
                    <input type="number" step="0.001" id="quantity" required>
                    <label>Making Charges Type*</label>
                    <div class="radio-group">
                        <input type="radio" id="mcGrams" name="mcType" value="grams" checked>
                        <label for="mcGrams">In Grams</label>
                        <input type="radio" id="mcPercent" name="mcType" value="percent">
                        <label for="mcPercent">In %</label>
                    </div>
                    <label for="makingCharges">Making Charges*</label>
                    <input type="number" step="0.01" id="makingCharges" required>
                    <label for="stoneCharges">Stone Charges (if any)</label>
                    <input type="number" step="0.01" id="stoneCharges" value="0">
                </section>
                
                <section class="total-display">
                    <small>Total Estimated Cost (incl. 3% GST)</small>
                    <strong id="final-total">₹ 0.00</strong>
                </section>
                
                <section class="action-buttons">
                    <!-- Buttons are dynamically controlled by script -->
                </section>
            </form>
        </div>
    </div>
    
    <!-- Hidden slip for actual printing -->
    <div id="print-slip" class="print-only"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
        // =================================================================
        // ==== CONFIGURATION & API KEYS ====
        // =================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCKEMK9IL_aDv1FIGKdzNzCtKYMmSrMxQA",
          authDomain: "mksjewels-estimator.firebaseapp.com",
          projectId: "mksjewels-estimator",
          storageBucket: "mksjewels-estimator.firebasestorage.app",
          messagingSenderId: "686445291013",
          appId: "1:686445291013:web:b8783b0f050f7d1955de6c",
        };

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyC-NIj62N-QdaVysFFzctbUeu29lk-yuvajlgQNrdex95qAfDyHkgKaLsaEcaPwSHHHw/exec';

        // =================================================================
        // =================== APPLICATION LOGIC ===================
        // =================================================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // --- AUTH GUARD & AUTO-LOGOUT ---
        const userJSON = sessionStorage.getItem('employeeUser');
        if (!userJSON || (new Date().getTime() - JSON.parse(userJSON).loginTime > 24 * 60 * 60 * 1000)) {
            sessionStorage.removeItem('employeeUser');
            localStorage.removeItem('lastEntry');
            if (userJSON) alert('Your session has expired. Please log in again.');
            window.location.href = './index.html';
        }

        // --- DOM ELEMENT SELECTORS ---
        const form = document.getElementById('estimation-form');
        const elements = {
            rate: document.getElementById('rate'),
            logoutBtn: document.getElementById('logout-btn'),
            exportBtn: document.getElementById('export-btn'),
            refreshRateBtn: document.getElementById('refresh-rate-btn'),
            ratesContainer: document.getElementById('rates-container'),
            finalTotal: document.getElementById('final-total'),
            printSlipContainer: document.getElementById('print-slip'),
            actionButtons: document.querySelector('.action-buttons'),
        };
        let estimationId = null; // To hold the current slip's ID

        // --- UPGRADED GOLD RATE WIDGET ---
        async function fetchGoldRate() {
            elements.ratesContainer.innerHTML = `<p style="text-align: center;">Fetching latest rates...</p>`;
            try {
                // In a real app, replace this with a real API call.
                await new Promise(resolve => setTimeout(resolve, 800)); // Simulate network delay
                const base24k = 7200;
                const randomFluctuation = Math.random() * 150 - 75;
                const live24k = (base24k + randomFluctuation);
                const live22k = live24k * (22/24);

                const rates = [
                    { purity: '24k', price: live24k.toFixed(2) },
                    { purity: '22k', price: live22k.toFixed(2) },
                ];
                
                elements.ratesContainer.innerHTML = rates.map(rate => `
                    <div class="rate-entry">
                        <div class="rate-details">
                            ${rate.purity} Gold: <strong>₹ ${rate.price}</strong>
                        </div>
                        <button type="button" class="use-rate-btn" data-rate="${rate.price}">Use this Rate</button>
                    </div>
                `).join('');

                // Add event listeners to the new buttons
                document.querySelectorAll('.use-rate-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        elements.rate.value = btn.dataset.rate;
                        calculateTotalAndUpdateDisplay(); // Update total when rate is selected
                    });
                });

            } catch (error) {
                console.error("Could not fetch gold rate:", error);
                elements.ratesContainer.innerHTML = `<p style="text-align: center; color: #ff8a80;">Error fetching rates.</p>`;
            }
        }
        
        // --- CALCULATIONS & DISPLAY ---
        function calculateTotalAndUpdateDisplay() {
            const formData = getFormData();
            const q = +formData.quantity, r = +formData.rate, mc = +formData.makingCharges, s = +formData.stoneCharges;
            let t = 0;
            if (formData.mcType === "grams") {
                t = ((q + mc) * r + s) * 1.03;
            } else {
                t = (((q + (q * (mc / 100))) * r) + s) * 1.03;
            }
            elements.finalTotal.textContent = `₹ ${t.toFixed(2)}`;
        }

        // --- DATA HANDLING ---
        function getFormData() {
            return {
                estimationId: estimationId,
                employeeName: JSON.parse(userJSON).name,
                customerName: document.getElementById('customerName').value,
                mobileNumber: document.getElementById('mobileNumber').value,
                city: document.getElementById('city').value,
                panNumber: document.getElementById('panNumber').value.toUpperCase(),
                ornament: document.getElementById('ornament').value,
                rate: elements.rate.value || '0',
                quantity: document.getElementById('quantity').value || '0',
                mcType: document.querySelector('input[name="mcType"]:checked').value,
                makingCharges: document.getElementById('makingCharges').value || '0',
                stoneCharges: document.getElementById('stoneCharges').value || '0',
            };
        }

        // --- BUTTON STATE & EVENT HANDLERS ---
        function setButtonState(state) {
            elements.actionButtons.innerHTML = ''; // Clear existing buttons
            if (state === 'new') {
                elements.actionButtons.innerHTML = `<button type="submit" id="saveBtn" form="estimation-form">Save Estimate</button>`;
            } else if (state === 'saved') {
                elements.actionButtons.innerHTML = `
                    <button type="button" id="printBtn">Print</button>
                    <button type="button" id="newSlipBtn">New Slip</button>`;
                document.getElementById('printBtn').addEventListener('click', handlePrint);
                document.getElementById('newSlipBtn').addEventListener('click', resetForm);
            }
        }
        
        elements.logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('employeeUser');
            localStorage.removeItem('lastEntry');
            window.location.href = './index.html';
        });

        form.addEventListener('input', calculateTotalAndUpdateDisplay);
        elements.refreshRateBtn.addEventListener('click', fetchGoldRate);

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            const formData = getFormData();
            const totalAmount = parseFloat(elements.finalTotal.textContent.replace('₹ ', '')).toFixed(2);
            const dataToSave = { ...formData, totalAmount };

            localStorage.setItem('lastEntry', JSON.stringify(dataToSave));

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave)
            }).then(() => {
                setButtonState('saved');
                alert('Estimation saved successfully!');
            }).catch(error => {
                console.error('Error:', error);
                alert('Failed to save estimation.');
                saveBtn.textContent = 'Save Estimate';
                saveBtn.disabled = false;
            });
        });
        
        function handlePrint() {
            populatePrintSlip(getFormData());
            window.print();
        }

        function populatePrintSlip(data) {
            const maskedMobile = data.mobileNumber ? 'x'.repeat(data.mobileNumber.length - 3) + data.mobileNumber.slice(-3) : '';
            const total = parseFloat(elements.finalTotal.textContent.replace('₹ ', '')).toFixed(2);
            
            const slipHTML = `
                <div class="print-header">
                    <h3>Keshava Jewellers, Sagara</h3>
                    <p>elv8.works</p>
                    <div class="divider"></div>
                    <h4>Estimation Slip</h4>
                    <div class="divider"></div>
                </div>
                <div class="print-main">
                    <div class="print-row"><span class="label">Employee:</span><span class="value">${data.employeeName}</span></div>
                    <div class="print-row"><span class="label">Customer:</span><span class="value">${data.customerName}</span></div>
                    <div class="print-row"><span class="label">City:</span><span class="value">${data.city}</span></div>
                    <div class="print-row"><span class="label">Mobile:</span><span class="value">${maskedMobile.replace(/x/g, '')}</span></div>
                    <div class="print-row"><span class="label">Ornament:</span><span class="value">${data.ornament}</span></div>
                    <div class="print-row"><span class="label">Quantity:</span><span class="value">${data.quantity} gms</span></div>
                    <div class="print-row"><span class="label">Rate:</span><span class="value">${data.rate}</span></div>
                    <div class="print-row"><span class="label">Making Charges:</span><span class="value">${data.makingCharges} ${data.mcType === 'grams' ? 'gms' : '%'}</span></div>
                    <div class="print-row"><span class="label">Stone Charges:</span><span class="value">${data.stoneCharges}</span></div>
                    <div class="print-row total-row"><span class="label">Total Estimated Cost:</span><span class="value">₹ ${total}</span></div>
                    <div class="print-row"><span class="label">Estimation ID:</span><span class="value">${data.estimationId}</span></div>
                </div>
                <div class="print-footer">
                    <p>Note: This estimated cost is valid for 24 hours.</p>
                </div>
            `;
            elements.printSlipContainer.innerHTML = slipHTML;
        }

        elements.exportBtn.addEventListener('click', () => {
            const data = getFormData();
            const total = parseFloat(elements.finalTotal.textContent.replace('₹ ', '')).toFixed(2);
            const headers = ["Estimation ID", "Date", "Employee", "Customer", "Mobile", "City", "PAN", "Ornament", "Quantity (gms)", "Rate", "MC Type", "MC Value", "Stone Charges", "Total Amount"];
            const values = [
                data.estimationId, new Date().toLocaleDateString('en-IN'), data.employeeName, data.customerName, data.mobileNumber, data.city, data.panNumber,
                data.ornament, data.quantity, data.rate, data.mcType, data.makingCharges, data.stoneCharges, total
            ];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + values.map(e => `"${e}"`).join(",");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Estimation_${data.estimationId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
      
        function resetForm() {
            form.reset();
            estimationId = Math.floor(10000 + Math.random() * 90000);
            document.getElementById('customerName').focus();
            setButtonState('new');
            calculateTotalAndUpdateDisplay();
            fetchGoldRate();
        }

        // --- INITIALIZE APP ---
        window.addEventListener('DOMContentLoaded', resetForm);
    </script>
</body>
</html>

