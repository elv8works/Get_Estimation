<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keshava Jewellers - Estimation Form</title>
<style>
body {
  font-family: "Inter", sans-serif;
  background:#f3f4f6;
  margin:0;
  padding:0;
}
.container {
  max-width:700px;
  margin:40px auto;
  background:#fff;
  padding:30px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.logo { text-align:center; margin-bottom:10px; }
.logo img { width:100px; }
h1,h3 { text-align:center; margin:5px 0; }

label { display:block; margin-bottom:5px; font-weight:500; color:#333; }
input, select { width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; font-size:15px; text-align:left; }
.radio-group { display:flex; gap:15px; justify-content:flex-start; margin-bottom:15px; }
button { width:48%; padding:12px; border:none; border-radius:5px; font-size:16px; cursor:pointer; position:relative; }
.save-btn { background-color:#4f46e5; color:white; }
.save-btn:hover { background:#4338ca; }
#printBtn { background-color:gray; opacity:0.6; cursor:not-allowed; }
#printBtn.active { background-color:#007bff; opacity:1; cursor:pointer; }
.saving-text { display:none; font-weight:bold; color:#4f46e5; margin-left:10px; vertical-align:middle; }

/* Print layout */
@media print {
  body { background:white; margin:0; }
  .container { width:80mm; padding:10px; margin:0 auto; box-shadow:none; border-radius:0; text-align:left; }
  .btn-container, .radio-group, input, select { display:none !important; }
  .print-row { display:flex; justify-content:space-between; font-size:12px; border-bottom:1px dashed #ccc; padding:2px 0; }
  .logo img { width:50px; }
  h1,h3 { text-align:center; font-size:13px; margin:2px 0; }
  @page { size:80mm auto; margin:3mm; }
}
</style>
</head>
<body>

<div class="container" id="estimationContainer">
  <div class="logo"><img src="kc.png" alt="Logo"></div>
  <h1>Keshava Jewellers, Sagara</h1>
  <h3>Estimation Slip</h3>

  <form id="estimationForm">
    <label>Employee Name*</label>
    <input type="text" id="employeeName" readonly>

    <label>Customer Name*</label>
    <input type="text" id="customerName" required>

    <label>Mobile Number</label>
    <input type="text" id="mobileNumber" pattern="[0-9]{10}" title="Enter 10-digit number">

    <label>City</label>
    <input type="text" id="city">

    <label>PAN Number (Optional)</label>
    <input type="text" id="panNumber" placeholder="ABCDE1234F" maxlength="10">

    <label>Ornament Chosen</label>
    <input type="text" id="ornament">

    <label>Quantity (gms)</label>
    <input type="number" id="quantity" step="0.01">

    <label>Rate (per gm)</label>
    <input type="number" id="rate" step="0.01">

    <div class="radio-group">
      <label><input type="radio" name="mcType" value="grams" checked> MC in grams</label>
      <label><input type="radio" name="mcType" value="percent"> MC in %</label>
    </div>

    <label>Making Charges</label>
    <input type="number" id="makingCharges" step="0.01">

    <label>Stone Charges</label>
    <input type="number" id="stoneCharges" step="0.01">

    <label>Total Amount</label>
    <input type="text" id="amount" readonly style="background:#f9fafb;font-weight:bold;">

    <div class="btn-container" style="text-align:center;">
      <button type="button" class="save-btn" id="saveBtn">Save</button>
      <span class="saving-text" id="savingText">Saving...</span>
      <button type="button" id="printBtn" disabled>Print</button>
    </div>
  </form>

  <div id="printSection" style="display:none;">
    <div class="logo"><img src="kc.png" alt="Logo"></div>
    <h1>Keshava Jewellers, Sagara</h1>
    <h3>Estimation Slip</h3>
    <div id="printContent"></div>
  </div>
</div>

<script>
  // ðŸ”’ Restrict unauthorized access
  const loginTime = localStorage.getItem("loginTime");
  const employeeEmail = localStorage.getItem("employeeEmail");
  if(!employeeEmail || !loginTime || (Date.now() - loginTime > 24*60*60*1000)){
    alert("You are not logged in. Please login first.");
    window.location.href = "index.html";
  }

  document.getElementById("employeeName").value = employeeEmail.split("@")[0];

  // ðŸ§® Auto-calculate
  const q=document.getElementById("quantity"), r=document.getElementById("rate"),
        m=document.getElementById("makingCharges"), s=document.getElementById("stoneCharges"),
        a=document.getElementById("amount"), mcType=document.getElementsByName("mcType");
  function calc(){
    const qty=parseFloat(q.value)||0, rate=parseFloat(r.value)||0,
          mc=parseFloat(m.value)||0, st=parseFloat(s.value)||0;
    const t=[...mcType].find(x=>x.checked).value;
    let total = (t==="grams") ? ((qty+mc)*rate+st)*1.03 : ((qty+(qty*(mc/100)))*rate+st)*1.03;
    a.value=total.toFixed(2);
  }
  [q,r,m,s].forEach(el=>el.addEventListener("input",calc));
  mcType.forEach(r=>r.addEventListener("change",calc));

  // ðŸ†” Generate ID
  function genID(){ return "EST-"+Date.now(); }

  const scriptURL="YOUR_GOOGLE_SCRIPT_WEBAPP_URL"; // Replace this

  // âœ… PAN regex
  function validPAN(pan){
    if(!pan) return true; // optional
    return /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(pan.toUpperCase());
  }

  const saveBtn=document.getElementById("saveBtn"), savingText=document.getElementById("savingText"), printBtn=document.getElementById("printBtn");

  saveBtn.addEventListener("click",async ()=>{
    const pan=document.getElementById("panNumber").value.trim().toUpperCase();
    if(pan && !validPAN(pan)){
      alert("Invalid PAN format! Must be like ABCDE1234F");
      return;
    }

    const data={
      employeeName:document.getElementById("employeeName").value,
      customerName:document.getElementById("customerName").value,
      mobileNumber:document.getElementById("mobileNumber").value,
      city:document.getElementById("city").value,
      panNumber:pan,
      ornament:document.getElementById("ornament").value,
      quantity:q.value,
      rate:r.value,
      mcType:[...mcType].find(r=>r.checked)?.value,
      makingCharges:m.value,
      stoneCharges:s.value,
      amount:parseFloat(a.value)||0
    };

    if(!data.customerName){ alert("Customer Name is mandatory!"); return; }

    saveBtn.disabled=true; savingText.style.display="inline";

    // ðŸ§© Split logic
    const MAX=199000;
    let remain=data.amount; let base=genID(); const entries=[];
    if(remain<=MAX||data.panNumber){
      entries.push({...data,estimationID:base});
    }else{
      let i=0;
      while(remain>0){
        const amt=remain>MAX?MAX:remain;
        entries.push({...data,amount:amt,estimationID:base+"-"+(++i)});
        remain-=amt;
      }
    }

    // ðŸš« Check for duplicate PAN in Google Sheet before saving
    // if(pan){
    //   const res=await fetch(`${scriptURL}?panCheck=${pan}`);
    //   const json=await res.json();
    //   if(json.exists){
    //     alert("This PAN already exists in records!");
    //     savingText.style.display="none";
    //     saveBtn.disabled=false;
    //     return;
    //   }
    // }

    // âœ… Save
    fetch(scriptURL,{method:"POST",body:JSON.stringify({entries})})
    .then(r=>r.json())
    .then(()=>{
      savingText.style.display="none";
      saveBtn.style.display="none";
      printBtn.disabled=false; printBtn.classList.add("active");
      alert("Saved successfully!");
      const pHTML=`
        <div class='print-row'><strong>Employee:</strong> <span>${data.employeeName}</span></div>
        <div class='print-row'><strong>Customer:</strong> <span>${data.customerName}</span></div>
        <div class='print-row'><strong>City:</strong> <span>${data.city}</span></div>
        <div class='print-row'><strong>Mobile:</strong> <span>${data.mobileNumber}</span></div>
        <div class='print-row'><strong>Ornament:</strong> <span>${data.ornament}</span></div>
        <div class='print-row'><strong>Quantity:</strong> <span>${data.quantity} gms</span></div>
        <div class='print-row'><strong>Rate:</strong> <span>${data.rate}</span></div>
        <div class='print-row'><strong>Making Charges:</strong> <span>${data.makingCharges}</span></div>
        <div class='print-row'><strong>Stone Charges:</strong> <span>${data.stoneCharges}</span></div>
        <div class='print-row'><strong>Total Amount:</strong> <span>â‚¹ ${data.amount.toFixed(2)}</span></div>
        <div class='print-row'><strong>Estimation ID:</strong> <span>${base}</span></div>`;
      document.getElementById("printContent").innerHTML=pHTML;
    })
    .catch(e=>{
      console.error(e);
      alert("Error saving!");
      savingText.style.display="none";
      saveBtn.disabled=false;
    });
  });

  printBtn.addEventListener("click",()=>{
    document.querySelector(".container").innerHTML=document.getElementById("printSection").innerHTML;
    window.print();
    window.location.reload();
  });
</script>
</body>
</html>
